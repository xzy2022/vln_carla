# 项目说明

## 1. 环境与版本

- 系统环境：Windows 11
- CARLA 版本：
  - `0.9.16`（UE4.26）
  - `0.10.0`（UE5.5）
- CARLA 安装路径：
  - UE4：`D:\Workspace\02_Playground\CARLA_Latest`（启动：`CarlaUE4.exe`）
  - UE5：`D:\Workspace\02_Playground\Carla-0.10.0-Win64-Shipping\Carla-0.10.0-Win64-Shipping`（启动：`CarlaUnreal.exe`）
- 项目根目录：`D:\Workspace\00_MyRepo\vln_carla`
- Python 环境：
  - UE4：`conda activate vln_carla_py312`
  - UE5：`conda activate vln_carla_ue5_py312`

说明：UE4 与 UE5 的 `carla` Python 包不得在同一环境混装，必须分环境管理。

## 2. 架构原则（强制）

本项目采用同心圆模型（Clean Architecture，见《架构整洁之道》）作为最高架构约束。

核心要求：

- 业务规则向内收敛，框架与外部系统向外隔离。
- 依赖方向只能从外层指向内层，内层不得依赖外层实现细节。
- 通过端口（接口）+ 适配器实现解耦，禁止跨层直接调用基础设施细节。
- 代码评审与合并以“是否破坏同心圆依赖规则”为硬门禁。

## 3. 同心圆分层定义

### 3.1 实体层（Entities，最内层）

职责：
- 纯业务对象与核心不变量。
- 不感知 CARLA、文件系统、网络、框架。

约束：
- 仅使用 Python 标准库与类型定义。
- 不出现 `carla`、`numpy`、`torch`、`yaml` 等外部依赖。

示例对象：
- `EpisodeSpec`、`InstructionSpec`、`EgoState`、`RiskWeights`、`Waypoint`。

### 3.2 用例层（Use Cases）

职责：
- 编排业务流程：reset/step、指令解析、风险代价聚合、规划与控制调用。
- 定义端口接口（抽象协议），不依赖具体适配器实现。

约束：
- 可依赖实体层；不可依赖接口适配层与基础设施层。
- 通过依赖注入接收端口实现。

端口示例：
- `WorldPort`（仿真世界交互）
- `PerceptionPort`（感知推理）
- `PlannerPort`（路径规划）
- `LoggerPort`（日志落盘）

### 3.3 接口适配层（Interface Adapters）

职责：
- 将外部数据结构转换为用例层可用结构。
- 实现 DTO、Mapper、Controller、Presenter。

约束：
- 可依赖用例层与实体层。
- 不得把外部框架对象直接泄漏到用例层。

示例：
- `carla.Transform -> EgoState` 的映射。
- `carla sensor raw -> Observation DTO`。

### 3.4 基础设施层（Frameworks & Drivers，最外层）

职责：
- CARLA SDK、传感器订阅、配置文件、CLI、日志系统、模型推理框架、数据库/文件系统。

约束：
- 只能通过接口适配层暴露能力。
- 不得反向 import 内层具体实现以外的业务细节。

## 4. 目录与模块规范

推荐结构（可在不破坏分层前提下扩展）：

```text
src/vln_carla/
  domain/            # 实体层
  usecases/          # 用例层（含端口定义）
  adapters/          # 接口适配层
  infrastructure/    # 基础设施层
  app/               # 组装入口（依赖注入）
```

硬性规则：

- `domain/` 不得 import `adapters/`、`infrastructure/`。
- `usecases/` 不得 import `infrastructure/`。
- `adapters/` 可 import `usecases/` 与 `domain/`。
- `app/` 负责装配依赖，是唯一允许“知道全部层”的位置。

## 5. 依赖与导入规范

- 使用绝对导入，禁止隐式相对导入。
- 禁止循环依赖。
- 外部对象（如 `carla.Actor`）不得出现在 `domain/` 与 `usecases/` 的函数签名中。
- 端口接口优先采用 `typing.Protocol` 或抽象基类。

## 6. 编码规范

- Python 版本：3.12（当前项目基线）。
- 类型标注：新增/修改代码必须补齐函数签名类型。
- 文档字符串：公开模块与核心类必须有简明 docstring。
- 错误处理：
  - 用例层仅抛业务异常。
  - 基础设施异常在适配层转换后再向内传播。
- 配置管理：集中在 `configs/` 或统一配置模块，禁止魔法常量散落。

## 7. 测试规范

分层测试策略：

- `domain`：纯单元测试，无外部依赖。
- `usecases`：端口 mock 测试，验证业务编排。
- `adapters`：转换逻辑测试（输入输出结构断言）。
- `infrastructure`：集成测试（可选，需要 CARLA 服务）。

门禁要求：

- 新增用例必须至少包含一条成功路径与一条失败路径测试。
- 修复缺陷必须补回归测试。
- 未覆盖关键分支的改动不得合并。

## 8. CARLA 相关专项规范

- UE4/UE5 使用独立 conda 环境，禁止混装 wheel。
- 启动服务后，地图能力以 `client.get_available_maps()` 实测为准。
- 与地图/传感器相关的能力判断，禁止仅凭文档推断，必须有可复现实测记录。

## 9. 提交与评审规范

- Commit 信息应包含：`scope + intent + impact`。
- PR 描述必须说明：
  - 涉及层级（domain/usecases/adapters/infrastructure）
  - 是否新增端口或更改端口契约
  - 测试结果与风险点
- 评审优先级：
  1. 是否破坏依赖方向
  2. 是否引入业务泄漏（外部对象侵入内层）
  3. 是否缺少测试与回归保护

## 10. 术语约定

- 同心圆模型 = Clean Architecture = 实体层 / 用例层 / 接口适配层 / 基础设施层。
- 端口 = 内层定义的能力接口。
- 适配器 = 外层实现端口并做数据转换的组件。

## 11. 一票否决项

出现以下任一情况，改动应直接驳回：

- 内层模块 import 外层模块。
- 在 `domain/usecases` 直接使用 `carla` 对象。
- 以“先跑通”为由绕过端口，直接在用例层调用基础设施代码。
- 无测试保护的核心流程改动。
