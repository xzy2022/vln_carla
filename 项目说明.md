# 项目说明（Hexagonal + DDD v2.1 对齐版）

## 1. 文档目标与适用范围

本文档用于统一 `vln_carla` 的工程实现边界，作为开发、评审、测试、重构的硬性依据。  
架构标准以 `Hexagonal_DDD_Architecture_Standard_v2_1.md` 为准；本文结合本项目（Windows11 + CARLA + Python 3.12）给出可执行落地规则。

---

## 2. 项目目标与约束

### 2.1 项目目标

- 在 CARLA 环境内实现可运行的 VLN/自动驾驶最小闭环。
- 支持从指令或策略到车辆控制的完整链路：观测 -> 决策 -> 控制 -> 记录。
- 在保证可迭代速度的同时，维持稳定的架构边界，避免技术债扩散。

### 2.2 环境基线

- OS: Windows 11
- Python: 3.12
- CARLA:
  - `0.9.16`（UE4.26）
  - `0.10.0`（UE5.5）
- CARLA 安装路径：
  - UE4：`D:\Workspace\02_Playground\CARLA_Latest`（启动：`CarlaUE4.exe`）
  - UE5：`D:\Workspace\02_Playground\Carla-0.10.0-Win64-Shipping`（启动：`CarlaUnreal.exe`）
- 项目根目录：`D:\Workspace\00_MyRepo\vln_carla`
- Python 环境：
  - UE4：`conda activate vln_carla_py312`
  - UE5：`conda activate vln_carla_ue5_py312`

说明：UE4 与 UE5 的 `carla` Python 包必须分离到不同环境，禁止混装。

### 2.3 启动约定（UE4 / UE5）

统一入口：`src/app/main.py`

- UE4（推荐在 `vln_carla_py312` 环境）：
  - `python -m app.main --carla-version ue4`
- UE5（推荐在 `vln_carla_ue5_py312` 环境）：
  - `python -m app.main --carla-version ue5`
- 自定义可执行文件路径（覆盖版本默认路径）：
  - `python -m app.main --carla-path \"<CARLA_EXE_PATH>\"`
- 连接已启动的 CARLA 服务（不由本进程拉起）：
  - `python -m app.main --no-launch-server --host localhost --port 2000`

启动前检查：
- 启动流程会根据 `--carla-version` 检查当前 Python 环境中的 `carla` 包版本（仅校验目标版本）。
- 若未安装或版本不匹配，会输出带颜色的 `[warn]` 告警，但不强制中断启动。

生命周期同步：
- 由 `app.main` 拉起的 CARLA 进程会绑定到 Python 主进程生命周期；Python 退出时会主动终止该 CARLA 进程。
- 若 CARLA 进程被手动关闭，运行中的 Python 主流程会检测到并停止当前 episode，避免两端“僵持”。

---

### 2.4 参考文档说明
`Docs_Carla_UE4` 与 `Docs_Carla_UE5` 分别对应 CARLA 官方文档。
`PythonAPI_Carla_UE4` 与 `PythonAPI_Carla_UE5` 分别对应 CARLA 安装路径下的 Python API 文档。

---
## 3. 目标架构（强制）

以 `src/` 为根，采用以下分层：

```text
src/
  domain/            # 核心业务模型（实体/值对象/聚合/领域服务）
  usecases/          # 应用层（用例、应用服务、输入输出 DTO、应用端口）
  adapters/          # 主适配器（HTTP/CLI/MQ consumer/presenter/mapper）
  infrastructure/    # 从适配器（CARLA/DB/MQ/外部 API/文件系统等技术实现）
  app/               # 组合根（DI 装配、配置、启动、生命周期管理）
```

补充：

- 在 Hexagonal 语义中，`adapters/` 和 `infrastructure/` 都是适配器。
- 本项目采用二者分离是为了区分“入站协议处理”和“出站技术集成”。

---

## 4. 依赖规则（硬约束）

### 4.1 domain/

- 禁止 import: `usecases/`, `adapters/`, `infrastructure/`, `app/`
- 只表达业务不变量与核心语义。
- 不允许出现 `carla`、网络、文件系统、框架调用。

### 4.2 usecases/

- 允许 import: `domain/`
- 禁止 import: `adapters/`, `infrastructure/`, `app/`
- 负责业务编排、事务边界、输入输出 DTO、输入端口。
- 只依赖抽象，不依赖技术实现。

### 4.3 adapters/

- 允许 import: `usecases/`
- 禁止 import: `infrastructure/`, `app/`
- 负责入站协议转换、输入验证、调用 use case、输出呈现。
- 边界使用 DTO，禁止暴露 domain 实体到外部协议层。

### 4.4 infrastructure/

- 允许 import: `domain/`, `domain/ports`, `usecases/ports`
- 禁止 import: `adapters/`, `app/`
- 负责仓储实现、CARLA 客户端封装、日志落盘、外部系统调用等。

### 4.5 app/

- 可 import 全部层。
- 仅用于依赖注入与启动流程。
- 禁止放业务规则和用例编排逻辑。

---

## 5. 端口归属规则（必须执行）

- `domain/ports`：领域拥有的契约（例如聚合仓储、领域事件发布抽象）。
- `usecases/ports`：应用层拥有的出站依赖（环境交互、通知、集成、事务、读模型网关）。
- `infrastructure/` 只实现端口，不定义业务端口语义。
- 若归属不明确，优先放到“更内层且能自洽”的层级。

---

## 6. 与当前仓库结构的映射与迁移要求

当前仓库存在以下目录：

- `src/domain`
- `src/usecases`
- `src/adapters`
- `src/ports`
- `src/drivers`

为对齐 v2.1，执行以下迁移策略：

1. `src/ports/*` 按职责拆分：
- 领域拥有接口 -> `src/domain/ports/`
- 应用拥有接口 -> `src/usecases/ports/`

2. `src/drivers/main.py` -> `src/app/main.py`（仅保留启动与装配）。

3. `src/drivers/in_memory_logger.py` 等技术实现 -> `src/infrastructure/...`。

4. `src/drivers/simple_agent.py` 若作为策略实现：
- 若是入站控制器逻辑，放 `src/adapters/...`
- 若是外部技术依赖实现，放 `src/infrastructure/...`

5. 禁止新增 `src/ports` 与 `src/drivers` 作为长期目录；新代码按目标结构落位。

说明：迁移可分批进行，但新增代码必须先遵守目标结构。

---

## 7. CARLA 专项规则

- `carla` SDK 访问必须位于 `infrastructure/`（或基础设施相关适配器实现）中。
- `domain/` 与 `usecases/` 的函数签名中禁止出现 `carla.*` 类型。
- CARLA 左手系到项目右手系坐标转换集中在 adapter/infrastructure 映射层，禁止在用例层散落转换逻辑。
- 与地图、传感器能力相关结论必须附带可复现实测记录，禁止只引用文档结论。

---

## 8. CQRS 与事务边界

- 写路径（状态变更）必须经过聚合/领域规则。
- 读路径可采用读模型优化，不必回放完整聚合，但必须无副作用。
- 事务边界由 `usecases/` 统一协调；事务实现位于 `infrastructure/`。

---

## 9. 编码与质量门禁

### 9.1 编码规范

- 新增/修改代码必须有完整类型标注。
- 禁止循环依赖。
- 统一绝对导入，禁止跨层隐式捷径调用。
- 公开模块、核心类、关键函数必须有简洁 docstring。

### 9.2 测试规范

- `domain/`: 纯单元测试。
- `usecases/`: 端口 mock 测试，验证编排与边界。
- `adapters/`: DTO/映射/协议转换测试。
- `infrastructure/`: 与 CARLA 或外部系统的集成测试（可按环境条件执行）。

门禁：

- 新增用例至少覆盖 1 条成功路径 + 1 条失败路径。
- 缺陷修复必须补回归测试。
- 关键路径改动无测试保护不得合并。

---

## 10. PR 与评审要求

PR 描述必须包含：

- 影响层级：`domain/usecases/adapters/infrastructure/app`
- 是否新增或修改端口契约
- 风险点与回滚方案
- 测试结果（包含未执行项说明）

评审优先级：

1. 依赖方向是否被破坏
2. 是否发生外部对象向内层泄漏
3. 端口归属是否正确
4. 测试与回归保护是否充分

---

## 11. 一票否决项

出现以下任一情况，改动直接驳回：

- `domain/` 或 `usecases/` 依赖外层实现。
- 在 `domain/usecases` 直接使用 `carla` 或其他技术框架对象。
- 绕过端口，在用例层直接调用基础设施实现。
- 新增核心流程但无测试保护。
- 在 `app/` 放置业务逻辑。

---

## 12. 当前阶段实施建议

- 先完成结构迁移（`ports`/`drivers` 拆分）再扩展功能模块，避免后续大规模返工。
- 保持 `RunEpisodeUseCase` 作为应用层编排中心，逐步引入更细粒度 input/output DTO 和 use case input port。
- 在 CARLA adapter/infrastructure 边界补齐错误码与异常语义映射，减少技术异常泄漏到业务层。
