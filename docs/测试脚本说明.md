# 测试脚本说明

本文档记录 `tests/` 目录下各测试脚本的目标、覆盖内容与推荐执行方式。

## 执行方式

推荐通过项目脚本执行（已内置环境保护）：

```powershell
./scripts/run_tests.ps1 -q
```

说明：
- 脚本会设置 `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1`，避免第三方 pytest 插件导致卡住或 Ctrl+C 难以终止。
- 脚本会设置 `PYTHONPATH=src`，确保从仓库根目录执行时可正确导入项目模块。

若手动执行，请使用：

```powershell
$env:PYTEST_DISABLE_PLUGIN_AUTOLOAD="1"
$env:PYTHONPATH="src"
python -m pytest tests -q
```

## tests/conftest.py

目的：
- 在测试启动时将 `src/` 加入 `sys.path`，保证测试可导入 `domain/`、`usecases/`、`infrastructure/` 等包。

测试内容：
- 该文件不包含具体断言，仅负责测试运行环境初始化。

## tests/test_vehicle_command.py

目的：
- 验证领域对象 `VehicleCommand` 的输入边界处理逻辑。

测试内容：
- `test_vehicle_command_clamp`
  - 对超范围输入进行 `clamped()` 处理后，断言：
    - `throttle` 被限制到 `[0.0, 1.0]`
    - `steer` 被限制到 `[-1.0, 1.0]`
    - `brake` 被限制到 `[0.0, 1.0]`

## tests/test_conversions.py

目的：
- 验证 CARLA 左手坐标系到项目右手坐标系的基础转换逻辑。

测试内容：
- `test_location_velocity_flip_y`
  - 断言位置和速度转换时 `y` 轴符号翻转。
- `test_rotation_yaw_sign_flip`
  - 断言旋转转换后 `yaw` 符号翻转且 `roll/pitch` 保持预期。

## tests/test_usecase.py

目的：
- 验证应用层用例 `RunEpisodeUseCase` 的流程控制与停止机制。

测试内容：
- `test_run_episode_stops_on_done`
  - 使用 fake env/agent/logger，断言在 `done=True` 时按预期停止并汇总步数和奖励。
- `test_run_episode_stops_when_should_stop`
  - 通过 `should_stop` 回调模拟外部停止条件，断言用例可提前退出。

## 当前已知问题

- 在部分本地环境直接执行 `python -m pytest -q` 可能卡在插件自动加载阶段。
- 该问题与测试代码本身无关，建议统一使用 `scripts/run_tests.ps1` 或显式设置 `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1`。

## demo/list_vehicle_blueprints.py

目的：
- 连接正在运行的 CARLA（UE5），打印当前环境可用的车辆蓝图列表。
- 为 demo 选车、脚本参数配置和场景验证提供快速检查入口。

执行方式：

```powershell
python demo/list_vehicle_blueprints.py
```

常用参数：
- `--filter`：蓝图过滤表达式，默认 `vehicle.*`。
- `--host` / `--port`：CARLA RPC 地址，默认 `127.0.0.1:2000`。
- `--timeout`：连接超时时间（秒）。

输出内容：
- 当前连接信息（host/port、地图名、过滤表达式）。
- 匹配到的车型总数。
- 按编号输出每个车型的 `Blueprint ID`（如 `vehicle.mini.cooper`）。

具体车型的介绍参见`docs\车型说明.md`。