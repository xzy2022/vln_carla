# 自车感知（UE5）

本文档聚焦 CARLA UE5 中“自车可获取信息”的两大来源：
- 上帝真值（直接从仿真状态读取）
- 车载传感器（IMU、GNSS 等）

参考文档：
- `PythonAPI_Carla_UE5/python_api.md`
- `Docs_Carla_UE5/core_world.md`
- `Docs_Carla_UE5/ref_sensors.md`

## 1. 上帝真值（Ground Truth）

### 1.1 单车接口（推荐）

可直接从 `vehicle` 读取真值状态：
- `vehicle.get_location()`：位置（m）
- `vehicle.get_transform()`：位姿（位置+姿态）
- `vehicle.get_velocity()`：线速度向量（m/s）
- `vehicle.get_acceleration()`：线加速度向量（m/s^2）
- `vehicle.get_angular_velocity()`：角速度向量

典型用法：

```python
import math

def read_ego_truth(vehicle):
    tf = vehicle.get_transform()
    vel = vehicle.get_velocity()
    acc = vehicle.get_acceleration()
    ang = vehicle.get_angular_velocity()

    speed_mps = math.sqrt(vel.x**2 + vel.y**2 + vel.z**2)
    return {
        "location": tf.location,
        "rotation": tf.rotation,
        "velocity": vel,
        "acceleration": acc,
        "angular_velocity": ang,
        "speed_mps": speed_mps,
        "speed_kph": speed_mps * 3.6,
    }
```

### 1.2 同帧真值（多目标一致时间基准）

若需要“同一帧”对比自车与周车，使用 `WorldSnapshot`：
- `snapshot = world.wait_for_tick()`（异步模式）
- 或 `world.on_tick(callback)` 注册回调
- `snapshot.find(vehicle.id)` 得到该帧自车 `ActorSnapshot`

典型用法：

```python
snapshot = world.wait_for_tick()
ego_snap = snapshot.find(vehicle.id)
if ego_snap:
    tf = ego_snap.get_transform()
    vel = ego_snap.get_velocity()
    acc = ego_snap.get_acceleration()
```

## 2. 车载传感器（IMU / GNSS）

### 2.1 IMU

- Blueprint：`sensor.other.imu`
- 输出类型：`carla.IMUMeasurement`
- 关键字段：
  - `accelerometer`（m/s^2）
  - `gyroscope`（rad/s）
  - `compass`（rad）
  - `frame` / `timestamp` / `transform`

挂载与监听：

```python
imu_bp = world.get_blueprint_library().find("sensor.other.imu")
imu = world.spawn_actor(imu_bp, carla.Transform(), attach_to=vehicle)
imu.listen(lambda data: print(data.accelerometer, data.gyroscope, data.compass))
```

### 2.2 GNSS

- Blueprint：`sensor.other.gnss`
- 输出类型：`carla.GnssMeasurement`
- 关键字段：
  - `latitude` / `longitude` / `altitude`
  - `frame` / `timestamp` / `transform`

挂载与监听：

```python
gnss_bp = world.get_blueprint_library().find("sensor.other.gnss")
gnss = world.spawn_actor(
    gnss_bp,
    carla.Transform(carla.Location(x=1.0, z=2.8)),
    attach_to=vehicle,
)
gnss.listen(lambda data: print(data.latitude, data.longitude, data.altitude))
```

## 3. 里程计（Odometry）说明

在本仓库的 UE5 文档中（`ref_sensors.md` 与 `python_api.md`）没有原生 `odometry` 传感器条目。  
常见做法是自行组合：
- 位姿：`get_transform()` 或 `ActorSnapshot.get_transform()`
- 速度：`get_velocity()`
- 时间：`WorldSnapshot.timestamp` 或 `SensorData.timestamp`

再映射成你的里程计数据结构（如 ROS2 `nav_msgs/Odometry`）。

## 4. 推荐采样策略

1. 控制评估：以 `WorldSnapshot` 为主时间基准，保证多车同帧对齐。  
2. 自车定位链路调试：并行记录 `真值 + IMU + GNSS`。  
3. 对比实验：固定同步模式和 `fixed_delta_seconds`，减少抖动。  
